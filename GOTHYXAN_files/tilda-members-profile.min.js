function tma__profile__drawProfilePopup(){window.tildaMembers.upload||(window.tildaMembers.upload={}),document.addEventListener("click",function(e){var a,t,i;e.target.classList.contains("tlk-userbar__popup-edit-profile")&&(e=tma__profile__getFormEditProfileHtml(a=tma__getProfileObjFromLS()),tma__drawPopup({id:"edit-profile",main:document.getElementById("app"),content:tma__translate(e,"userbar_dict"),closeBtns:[".tlk-popup__close-cancel"]}),tma__profile__addUploadEvents(),tma__profile__initPhoneMask(),e=(t=document.getElementById("form-change-profile")).querySelector(".tlk-popup__change-password"),i=t.querySelector(".js-invalid-phone-input"),a.memberlogo_uuid&&(window.tildaMembers.upload.id=a.memberlogo_uuid,window.tildaMembers.upload.oldId=a.memberlogo_uuid),t&&t.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),tma__profile__submitEditProfile(t)}),e&&e.addEventListener("click",function(){var e=tma__profile__getFormChangePasswordHtml(),t=(tma__drawPopup({id:"change-password",main:document.getElementById("app"),content:tma__translate(e,"userbar_dict"),closeBtns:[".tlk-popup__close-cancel"]}),document.getElementById("change-password")),i=document.getElementById("form-change-password"),o=i.querySelector('button[type="submit"]');tma__profile__addButtonShowHidePasswordEvents(),i.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation(),tma__resetErrorFields(i),tma__resetErrorRequest(i);var e=tma__validationFormFields(i);0<e.length?tma__showErrorFields(i,e,"userbar_dict"):(window.tildaMembers.timezoneOffset||(window.tildaMembers.timezoneOffset=(new Date).getTimezoneOffset()),(e=tma__serializeArray(i)).projectid=a.projectid,e.token=a.token,e.tzoffset=window.tildaMembers.timezoneOffset,tma__request("/api/editpassword/",JSON.stringify(e),o,function(e){"ok"===e.status?(tma__showSuccessRequest(i,tma__translate("{{change_password_success_text}}","userbar_dict")),setTimeout(function(){tma__closePopup(t)},1e3)):e.code&&tma__showErrorRequest(i,e.code,"userbar_dict","change_password")}))})}),i)&&i.addEventListener("focus",function(){var e=tma__profile__createPhoneInputHtml({name:i.name||"phone",placeholder:i.placeholder||"",value:i.value||"",required:i.required||!1}),e=(i.insertAdjacentHTML("beforebegin",e),i.remove(),tma__profile__initPhoneMask(),t.querySelector(".t-input-phonemask"));e&&e.focus()})})}function tma__profile__submitEditProfile(i,o){var e,a=tma__getProfileObjFromLS(),t=i.querySelector(".tlk-popup__change-lang"),l=i.querySelector('button[type="submit"]'),r=!1,s=(tma__resetErrorFields(i),tma__resetErrorRequest(i),tma__validationFormFields(i));0<s.length?tma__showErrorFields(i,s,"userbar_dict"):(window.tildaMembers.timezoneOffset||(window.tildaMembers.timezoneOffset=(new Date).getTimezoneOffset()),s={name:a.name,login:a.login,phone:a.phone,memberlogo:a.memberlogo_uuid,projectid:a.projectid,token:a.token,tzoffset:window.tildaMembers.timezoneOffset},Object.assign(s,tma__serializeArray(i)),window.tildaMembers.upload&&window.tildaMembers.upload.id&&(s.memberlogo=window.tildaMembers.upload.id),t&&window.tildaMembers.userLang!==t.value&&(s.lang=t.value,r=!0),o&&o.additionalData&&Object.assign(s,o.additionalData),t=a.phoneneedcaptcha&&s.phone&&s.phone!==a.phone,e=a.emailneedcaptcha&&s.login&&s.login!==a.login,s.rkey||!t&&!e?tma__request("/api/editprofile/",JSON.stringify(s),l,async function(e){var t;"ok"===e.status&&"object"==typeof e.data?(t=e.data,window.tildaMembers.upload.id="",a.name=t.name,a.login=t.login,a.emailneedcaptcha=t.emailneedcaptcha,a.phoneneedcaptcha=t.phoneneedcaptcha,a.isPhoneValid=!e.data.phone||"function"!=typeof tma__validatePhone||await tma__validatePhone(e.data.phone.toString()),t.hasOwnProperty("phone")&&(a.phone=t.phone),t.memberlogo_uuid?(a.memberlogo=t.memberlogo,a.memberlogo_uuid=t.memberlogo_uuid):(a.memberlogo="",a.memberlogo_uuid=""),window.tildaMembers&&window.tildaMembers.settingStyles&&window.tildaMembers.settingStyles.code&&t.code&&(window.tildaMembers.settingStyles.code=t.code),tma__showSuccessRequest(i,tma__translate("{{edit_profile_success_text}}","userbar_dict")),tma__resetErrorFields(i),t="tilda_members_profile"+a.projectid,localStorage.setItem(t,JSON.stringify(a)),localStorage.setItem(t+"_timestamp",Math.floor(Date.now()/1e3)),(t=i.querySelector(".js-invaid-phone-icon"))&&t.remove(),r?setTimeout(function(){window.location.reload()},1e3):tma__userbar__updateDataProfile(),o&&"function"==typeof o.onSuccess&&o.onSuccess(e)):(t=e.code||e.data)&&("need_captcha"===t?tma__profile__showRecaptchaEditProfile(i):tma__showErrorRequest(i,t,"userbar_dict","edit_profile"))}):tma__profile__showRecaptchaEditProfile(i))}function tma__profile__showRecaptchaEditProfile(t){function i(e){tma__profile__handleRecaptchaEditProfile(e,t)&&window.removeEventListener("message",i)}tma__profile__drawRecaptcha(function(){window.removeEventListener("message",i)}),window.addEventListener("message",i)}function tma__profile__handleRecaptchaEditProfile(e,t){var i;return-1!==e.origin.indexOf(window.tildaMembers.endpoint)&&!!(i=document.querySelector(".tlk-recaptcha"))&&(i.querySelector(".tlk-recaptcha__reg-captcha").contentWindow.postMessage("tilda-reset","*"),tma__profile__submitEditProfile(t,{additionalData:{rkey:e.data}}),tma__profile__closeRecaptcha(i),!0)}function tma__profile__addUploadEvents(){var r=document.querySelector(".tlk-popup__close-save"),s=document.querySelector(".tlk-upload"),n=s.querySelector('input[type="file"]'),d=s.querySelector(".tlk-upload__button"),_=s.querySelector(".tlk-upload__error"),p=s.querySelector(".tlk-upload__preview"),e=s.querySelector(".tlk-upload__reset"),c=["image/png","image/jpg","image/jpeg","image/gif"];function m(){window.tildaMembers.upload.id="",n.value="",p.innerHTML=""}e&&e.addEventListener("click",m),n.addEventListener("change",function(){var e=n.files[0],t=e.type,i=parseFloat((+e.size/Math.pow(1024,2)).toFixed(4)),o=!1;_.classList.remove("tlk-upload__error_show"),_.innerHTML="";for(var a,l=0;l<c.length;l++)if(c[l]===t){o=!0;break}o?2<i?(_.innerHTML=tma__translate("{{field_file_size}}","userbar_dict"),_.classList.add("tlk-upload__error_show"),n.value=""):(i=tma__getProfileObjFromLS(),(a=new FormData).append("projectid",i.projectid),a.append("token",i.token),a.append("file",e),a.append("tzoffset",(new Date).getTimezoneOffset()),r.disabled=!0,tma__request("/api/uploadmemberlogo/",a,d,function(e){"ok"===e.status&&"object"==typeof e.data?(window.tildaMembers.upload.id=e.data.uuid,p.innerHTML='<img src="'+e.data.cdnurl+'"><button type="button" class="tlk-upload__reset tlk-btn_reset"></button>',s.querySelector(".tlk-upload__reset").addEventListener("click",m)):e.code&&(_.innerHTML=tma__translate("{{upload_logo_"+e.code+"}}","userbar_dict"),_.classList.add("tlk-upload__error_show")),r.disabled=!1},!0)):(_.innerHTML=tma__translate("{{field_file_type}}","userbar_dict"),_.classList.add("tlk-upload__error_show"),n.value="")})}function tma__profile__addButtonShowHidePasswordEvents(){for(var e=document.querySelectorAll(".tlk-password-toggle"),t=0;t<e.length;t++)e[t].addEventListener("click",function(){var e=this.parentNode.querySelector("input");this.classList.toggle("tlk-password-toggle__show"),this.classList.contains("tlk-password-toggle__show")?e.setAttribute("type","text"):e.setAttribute("type","password")})}function tma__profile__getFormEditProfileHtml(e){var t=tma__profile__getLoginType(),i="",o=!e.allowEditProfile&&"email"===t,a=!o&&"email"===t,l=!e.allowEditProfile&&"phone"===t,t=!l&&"phone"===t,r=e.isPhoneValid,i=(i=(i=(i=(i=(i+='<div class="tlk-popup__title" data-field="tlk-title">{{form_edit_profile_title}}</div>')+'<form method="post" id="form-change-profile" action="/">'+'<div class="tlk-popup__form-wrap">')+'<div class="tlk-popup__item tlk-form__item">'+'<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_name}}</div>')+('<input type="text" name="name" placeholder="{{form_edit_profile_placeholder_name}}" class="tlk-input" value="'+tma__escapeHTML(e.name)+'" required>')+'<div class="tlk-input-error"></div>')+"</div>"+'<div class="tlk-popup__item tlk-form__item">')+'<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_email}}</div>'+('<input type="text" name="login" placeholder="{{form_edit_profile_placeholder_email}}" class="tlk-input" value="'+(e.login||"")+'"'+(a?" required":"")+(o?" disabled":"")+">");return o&&(i+='<input type="hidden" name="login"  value="'+(e.login||"")+'">'),i=(i=(i+='<div class="tlk-input-error"></div>')+"</div>"+'<div class="tlk-popup__item tlk-form__item">')+'<div class="tlk-input-title" data-field="tlk-text">'+"<span>{{form_edit_profile_field_phone}}</span>",r||(i+='<svg class="tlk-popup__warning-icon js-invaid-phone-icon" width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg" data-tooltip-text="{{widget_userbar_warning_phone}}"><path d="M17 8.5C17 13.1944 13.1944 17 8.5 17C3.80558 17 0 13.1944 0 8.5C0 3.80558 3.80558 0 8.5 0C13.1944 0 17 3.80558 17 8.5Z" fill="#EA3323"/><path d="M8.25488 10.1543L7.89844 6.52148V4.8418H9.38281V6.52148L9.03125 10.1543H8.25488ZM7.95703 12V10.6279H9.3291V12H7.95703Z" fill="white"/></svg>'),i=(i+="</div>")+(r?tma__profile__createPhoneInputHtml({name:"phone",placeholder:"{{form_edit_profile_placeholder_phone}}",disabled:!e.allowEditProfile,value:e.phone,required:t}):'<input type="text" name="phone" placeholder="{{form_edit_profile_placeholder_phone}}" class="tlk-input js-invalid-phone-input" value="'+(e.phone||"")+'"'+(t?" required":"")+(l?" disabled":"")+">"),l&&(i+='<input type="hidden" name="phone"  value="'+(e.phone||"")+'">'),i=(i=(i=(i=i+'<div class="tlk-input-error"></div>'+"</div>")+'<div class="tlk-popup__item tlk-form__item">'+'<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_image}}</div>')+'<div class="tlk-upload">'+'<label class="tlk-upload__button" for="image-file">{{form_edit_profile_btn_image}}<span class="tlk-loadicon"></span></label>')+'<input type="file" accept="image/png, image/jpg, image/jpeg, image/gif" id="image-file">'+'<div class="tlk-upload__preview">',i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=e.memberlogo?i+('<img src="'+e.memberlogo)+'"><button type="button" class="tlk-upload__reset tlk-btn_reset"></button>':i)+"</div>"+'<div class="tlk-upload__error"></div>')+"</div>"+"</div>")+'<div class="tlk-popup__item tlk-form__item">'+'<div class="tlk-input-title" data-field="tlk-text">{{form_edit_profile_field_lang}}</div>')+'<div class="tlk-select">'+'<select type="button" class="tlk-popup__change-lang">')+('<option value="RU"'+("RU"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_ru}}</option>"))+('<option value="EN"'+("EN"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_en}}</option>"))+('<option value="DE"'+("DE"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_de}}</option>"))+('<option value="ES"'+("ES"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_es}}</option>"))+('<option value="PT"'+("PT"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_pt}}</option>"))+('<option value="LV"'+("LV"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_lv}}</option>"))+('<option value="UK"'+("UK"===window.tildaMembers.userLang?" selected":"")+">{{form_edit_profile_lang_option_uk}}</option>")+"</select>")+"</div>"+"</div>",window.tildaMembers.settingStyles&&window.tildaMembers.settingStyles.authsettings&&"password"!==window.tildaMembers.settingStyles.authsettings.authtypeid||(i+='<div class="tlk-popup__item tlk-form__item"><button type="button" class="tlk-popup__change-password tlk-btn_reset">{{form_edit_profile_btn_change_password}}</button></div>'),i=(i=(i=(i+="</div>")+'<div class="tlk-input-error tlk-input-error_all"></div>'+'<div class="tlk-popup__buttons">')+'<button type="button" class="tlk-popup__close-cancel tlk-popup__button tlk-btn tlk-btn_white tlk-btn_reset">{{form_edit_profile_btn_cancel}}</button>'+'<button type="submit" class="tlk-popup__close-save tlk-popup__button tlk-btn tlk-btn_gray tlk-btn_reset">{{form_edit_profile_btn_save}}<span class="tlk-loadicon"></span></button>')+"</div>"+"</form>"}function tma__profile__getFormChangePasswordHtml(){return'<div class="tlk-popup__title" data-field="tlk-title">{{form_change_password_title}}</div><form method="post" id="form-change-password" action="/"><div class="tlk-popup__form-wrap"><div class="tlk-popup__item tlk-form__item"><div class="tlk-input-title" data-field="tlk-text">{{form_change_password_field_old_password}}</div><input type="password" name="password" class="tlk-input" required><div class="tlk-input-error"></div><div class="tlk-password-toggle"><svg class="tlk-password-toggle__visible-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z" fill="none" stroke="#777777" stroke-miterlimit="10"></path><circle class="st1" cx="10.8" cy="6.5" r="2.5" fill="#777777" stroke="#777777" stroke-miterlimit="10"></circle></svg><svg class="tlk-password-toggle__hidden-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z"></path><circle class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" cx="10.8" cy="6.5" r="2.5"></circle><line class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" x1="4.8" y1="12.5" x2="16.8" y2="0.5"></line></svg></div></div><div class="tlk-popup__item tlk-form__item"><div class="tlk-input-title" data-field="tlk-text">{{form_change_password_field_new_password}}</div><input type="password" name="newpassword" class="tlk-input" required><div class="tlk-input-error"></div><div class="tlk-password-toggle"><svg class="tlk-password-toggle__visible-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z" fill="none" stroke="#777777" stroke-miterlimit="10"></path><circle class="st1" cx="10.8" cy="6.5" r="2.5" fill="#777777" stroke="#777777" stroke-miterlimit="10"></circle></svg><svg class="tlk-password-toggle__hidden-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 21.5 12.9" style="enable-background:new 0 0 21.5 12.9;" xml:space="preserve"><path class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" d="M0.8,6.5c0,0,3.5,4.8,10,4.8s10-4.8,10-4.8s-3.5-4.8-10-4.8S0.8,6.5,0.8,6.5z"></path><circle class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" cx="10.8" cy="6.5" r="2.5"></circle><line class="st0" fill="none" stroke="#777777" stroke-miterlimit="10" x1="4.8" y1="12.5" x2="16.8" y2="0.5"></line></svg></div></div></div><div class="tlk-input-error tlk-input-error_all"></div><div class="tlk-popup__buttons"><button type="button" class="tlk-popup__close-cancel tlk-popup__button tlk-btn tlk-btn_white tlk-btn_reset">{{form_change_password_btn_cancel}}</button><button type="submit" class="tlk-popup__close-save tlk-popup__button tlk-btn tlk-btn_gray tlk-btn_reset">{{form_change_password_btn_save}}<span class="tlk-loadicon"></span></button></div></form>'}function tma__profile__drawRecaptcha(e){document.getElementById("allrecords").insertAdjacentHTML("beforeend",tma__profile__getRecaptchaHtml());var t=document.querySelector(".tlk-recaptcha");t.querySelector(".tlk-recaptcha__close").addEventListener("click",function(){tma__profile__closeRecaptcha(t),"function"==typeof e&&e()})}function tma__profile__getRecaptchaHtml(){var e="";return e+'<div class="tlk-recaptcha">'+'<button type="button" class="tlk-recaptcha__close tlk-btn_reset"></button>'+('<iframe class="tlk-recaptcha__reg-captcha" src="'+window.tildaMembers.endpoint+"/api/getrecaptcha/?lang="+window.tildaMembers.userLang+'"></iframe>')+"</div>"}function tma__profile__closeRecaptcha(e){e.remove()}function tma__profile__getLoginType(){return window.tildaMembers.settingStyles&&window.tildaMembers.settingStyles.authsettings&&window.tildaMembers.settingStyles.authsettings.logintypeid?window.tildaMembers.settingStyles.authsettings.logintypeid:"email"}function tma__profile__createPhoneInputHtml(e){var t=e.name||"",i=e.placeholder||"",o=e.iso||"RU",a=e.id||"111",l=e.value||"",r=e.disabled?"disabled":"",e=e.required?'data-tilda-req="1"':"",s=Math.floor(99999*Math.random()).toString();return`
    	<div id="rec${s}" class="tlk-popup__item tlk-form__item">
            <div class="t-input-group" data-input-lid="${a}" data-field-async="true" data-field-type="ph" data-field-name="${t}"> 
       
                <div class="t-input-block"> 
                    <input
                        type="tel"
                        autocomplete="tel"
                        name="${t}" 
                        id="input_${a}" 
                        data-phonemask-init="no"
                        data-phonemask-id="${s}" 
                        data-phonemask-lid="${a}" 
                        data-phonemask-maskcountry="${o}" 
                        class="t-input tlk-input js-phonemask-input js-tilda-rule"
                        value="${l}"
                        disabled="${r}"
                        placeholder="${i}" 
                        aria-describedby="error_${a}"
                        ${e}>
                </div>
                <div class="t-input-error tlk-input-error" aria-live="polite" id="error_${a}"></div>
            </div>
        </div>
    `}function tma__profile__initPhoneMask(){tma__loadJS("https://static.tildacdn.com/js/tilda-phone-mask-1.1.min.js"),tma__onFuncLoad("t_form_phonemask__initPhoneMask",function(){document.querySelectorAll(".js-phonemask-input").forEach(e=>{var t,i=e.closest(".t-input-group");i&&(t=e.value,e.value="",t_form_phonemask_load(e),t)&&tma__onFuncLoad("t_form_phonemask__setValue",function(){t_form_phonemask__setValue(i,t)})})})}
